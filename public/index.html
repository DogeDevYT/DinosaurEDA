<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web HDL IDE</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; 
            background-color: #1e1e1e;
        }

        #ide-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100%;
        }

        #controls {
            padding: 8px 12px;
            background-color: #333;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
            display: flex;
            gap: 10px;
        }

        .control-button {
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
        }

        #compile-button {
            background-color: #007acc;
        }
        #compile-button:hover {
            background-color: #005a9e;
        }

        #detach-button {
            background-color: #5a5a5a;
        }
        #detach-button:hover {
            background-color: #7a7a7a;
        }

        #editor-container {
            width: 100%;
            border-bottom: 2px solid #333;
            flex-grow: 6;
        }

        #terminal-container {
            width: 100%;
            background-color: #1a1a1a;
            flex-grow: 4;
        }

        .xterm .xterm-viewport {
            width: 100% !important;
        }
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
</head>

<body>
    <div id="ide-container">
        
        <div id="controls">
            <button id="compile-button" class="control-button">â–¶ Run Synthesis</button>
            <button id="detach-button" class="control-button">Detach Terminal</button>
        </div>

        <div id="editor-container"></div>
        <div id="terminal-container"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let editor; 
            let term; 
            let socket; 
            
            let terminalWindow = null; 
            let originalTerminalContainer = document.getElementById('terminal-container');

            // --- 1. INITIALIZE MONACO EDITOR ---
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                editor = monaco.editor.create(document.getElementById('editor-container'), {
                    value: [
                        '// --- Welcome to your Web IDE ---',
                        'module top (',
                        '  input clk,',
                        '  input rst,',
                        '  output reg [7:0] count',
                        ');',
                        '',
                        '  always @(posedge clk or posedge rst) begin',
                        '    if (rst) begin',
                        '      count <= 8\'d0;',
                        '    end else begin',
                        '      count <= count + 8\'d1;',
                        '    end',
                        '  end',
                        '',
                        'endmodule'
                    ].join('\n'),
                    language: 'verilog',
                    theme: 'vs-dark'
                });
                window.addEventListener('resize', () => editor.layout());
            });

            // --- 2. INITIALIZE XTERM.JS TERMINAL ---
            term = new Terminal({
                cursorBlink: true,
                theme: { background: '#1a1a1a' }
            });

            // Open the terminal in its default container
            term.open(originalTerminalContainer);
            term.write('Welcome to the HDL Compiler Terminal!\r\n');
            term.write('Connecting to backend server...\r\n');


            // --- 3. INITIALIZE WEBSOCKET ---
            const WEBSOCKET_URL = `wss://${window.location.host}/compile`; 

            function connectWebSocket() {
                try {
                    socket = new WebSocket(WEBSOCKET_URL);
                    socket.onopen = () => term.write('\x1b[32mSuccessfully connected to backend.\x1b[0m\r\n');
                    socket.onmessage = (event) => term.write(event.data.replace(/\n/g, '\r\n'));
                    socket.onerror = (error) => term.write('\x1b[31mWebSocket Error.\x1b[0m\r\n');
                    socket.onclose = () => term.write('\x1b[33mConnection to backend closed.\x1b[0m\r\n');
                } catch (err) {
                    term.write('\x1b[31mFailed to create WebSocket. ' + err.message + '\x1b[0m\r\n');
                }
            }
            connectWebSocket();

            // --- 4. HOOK UP "RUN" BUTTON ---
            document.getElementById('compile-button').addEventListener('click', () => {
                if (!editor) {
                    alert('Editor is not initialized yet.');
                    return;
                }
                
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    term.write('\x1b[31mNot connected to backend. Attempting to reconnect...\x1b[0m\r\n');
                    connectWebSocket();
                    return;
                }

                const code = editor.getValue();
                const payload = {
                    language: 'verilog',
                    code: code
                };
                socket.send(JSON.stringify(payload));
                
                term.write('\x1b[2J\x1b[H');
                term.write('--- Compilation started... ---\r\n');
            });


            // --- 5. LOGIC FOR DETACH/RE-ATTACH BUTTON ---
            const detachButton = document.getElementById('detach-button');
            
            // --- FIX: This function is now "idempotent" (safe) ---
            function reattachTerminal() {
                // 1. Check if the window exists. If not, we're done.
                if (!terminalWindow) {
                    return; 
                }
                
                // 2. Immediately grab the window and set the global to null
                //    This prevents this function from ever running twice
                //    on the same window.
                const win = terminalWindow;
                terminalWindow = null; 

                // 3. Now, safely re-attach everything
                originalTerminalContainer.style.display = 'block'; 
                term.open(originalTerminalContainer); 
                term.focus();

                // 4. Clean up the popup window
                win.onbeforeunload = null; // Break the event loop
                win.close();
                
                detachButton.textContent = 'Detach Terminal';
            }
            
            detachButton.addEventListener('click', () => {
                if (terminalWindow) {
                    // If window exists, run the re-attach logic
                    reattachTerminal();
                } else {
                    // If no window, run the detach logic
                    originalTerminalContainer.style.display = 'none'; 
                    
                    terminalWindow = window.open('', 'TerminalWindow', 'width=800,height=600');
                    if (!terminalWindow) {
                        alert('Popup blocked. Please allow popups for this site.');
                        originalTerminalContainer.style.display = 'block';
                        return;
                    }
                    
                    terminalWindow.document.head.innerHTML = `
                        <title>Terminal</title>
                        <style>
                            body, html { 
                                margin: 0; padding: 0; height: 100%; width: 100%; 
                                overflow: hidden; background-color: #1a1a1a; 
                            }
                        </style>
                    `;
                    
                    const xtermCss = terminalWindow.document.createElement('link');
                    xtermCss.rel = 'stylesheet';
                    xtermCss.href = 'https://cdn.jsdelivr.net/npm/xterm/css/xterm.css';
                    terminalWindow.document.head.appendChild(xtermCss);
                    
                    const newTermContainer = terminalWindow.document.createElement('div');
                    newTermContainer.id = 'new-terminal-container';
                    newTermContainer.style.height = '100%';
                    newTermContainer.style.width = '100%';
                    terminalWindow.document.body.appendChild(newTermContainer);
                    
                    term.open(newTermContainer);
                    term.focus();
                    
                    // Set the listener for when the user closes the popup
                    terminalWindow.onbeforeunload = () => {
                        reattachTerminal();
                    };
                    
                    detachButton.textContent = 'Re-attach Terminal';
                }
            });
        });
    </script>
</body>
</html>