<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DinosaurEDA IDE</title>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; 
            background-color: #1e1e1e;
        }

        #ide-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100%;
        }

        #controls {
            padding: 8px 12px;
            background-color: #333;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
            display: flex;
            gap: 10px;
        }

        .control-button {
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
        }

        #compile-button {
            background-color: #007acc;
        }
        #compile-button:hover {
            background-color: #005a9e;
        }

        #detach-button {
            background-color: #5a5a5a;
        }
        #detach-button:hover {
            background-color: #7a7a7a;
        }

        #editor-container {
            width: 100%;
            border-bottom: 2px solid #333;
            flex-grow: 6;
            transition: all 0.2s ease;
        }

        #terminal-container {
            width: 100%;
            background-color: #1a1a1a;
            flex-grow: 4;
            transition: all 0.2s ease;
            /* --- FIX: We need this to make sure xterm resizes --- */
            position: relative; 
        }

        /* --- FIX: Style the xterm element itself --- */
        .xterm {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
</head>

<body>
    <div id="ide-container">
        
        <div id="controls">
            <button id="compile-button" class="control-button">â–¶ Run Synthesis</button>
            <button id="detach-button" class="control-button">Detach Terminal</button>
        </div>

        <div id="editor-container"></div>
        <div id="terminal-container"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let editor; 
            let term; 
            let socket; 
            
            let terminalWindow = null; 
            let originalTerminalContainer = document.getElementById('terminal-container');
            let editorContainer = document.getElementById('editor-container');
            
            // --- NEW: Add the FitAddon for resizing ---
            const fitAddon = new FitAddon.FitAddon();


            // --- 1. INITIALIZE MONACO EDITOR ---
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                editor = monaco.editor.create(editorContainer, {
                    value: [
                        '// --- Welcome to your Web IDE ---',
                        'module top (',
                        '  input clk,',
                        '  input rst,',
                        '  output reg [7:0] count',
                        ');',
                        '',
                        '  always @(posedge clk or posedge rst) begin',
                        '    if (rst) begin',
                        '      count <= 8\'d0;',
                        '    end else begin',
                        '      count <= count + 8\'d1;',
                        '    end',
                        '  end',
                        '',
                        'endmodule'
                    ].join('\n'),
                    language: 'verilog',
                    theme: 'vs-dark'
                });
                window.addEventListener('resize', () => {
                    editor.layout();
                    // --- NEW: Resize terminal too ---
                    fitAddon.fit();
                });
            });

            // --- 2. INITIALIZE XTERM.JS TERMINAL ---
            term = new Terminal({
                cursorBlink: true,
                theme: { background: '#1a1a1a' }
            });

            // --- NEW: Load the resize addon ---
            term.loadAddon(fitAddon);

            // --- FIX: term.open() is ONLY CALLED ONCE ---
            term.open(originalTerminalContainer);
            fitAddon.fit(); // Make it fill the container
            
            term.write('Welcome to the HDL Compiler Terminal!\r\n');
            term.write('Connecting to backend server...\r\n');


            // --- 3. INITIALIZE WEBSOCKET ---
            const WEBSOCKET_URL = `wss://${window.location.host}/compile`; 

            function connectWebSocket() {
                try {
                    socket = new WebSocket(WEBSOCKET_URL);
                    socket.onopen = () => term.write('\x1b[32mSuccessfully connected to backend.\x1b[0m\r\n');
                    socket.onmessage = (event) => term.write(event.data.replace(/\n/g, '\r\n'));
                    socket.onerror = (error) => term.write('\x1b[31mWebSocket Error.\x1b[0m\r\n');
                    socket.onclose = () => term.write('\x1b[33mConnection to backend closed.\x1b[0m\r\n');
                } catch (err) {
                    term.write('\x1b[31mFailed to create WebSocket. ' + err.message + '\x1b[0m\r\n');
                }
            }
            connectWebSocket();

            // --- 4. HOOK UP "RUN" BUTTON ---
            document.getElementById('compile-button').addEventListener('click', () => {
                if (!editor) return;
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                    return;
                }
                const code = editor.getValue();
                socket.send(JSON.stringify({ language: 'verilog', code: code }));
                term.write('\x1b[2J\x1b[H--- Compilation started... ---\r\n');
            });


            // --- 5. LOGIC FOR DETACH/RE-ATTACH BUTTON (COMPLETELY REWRITTEN) ---
            const detachButton = document.getElementById('detach-button');
            
            function reattachTerminal() {
                if (!terminalWindow) return; 
                
                const win = terminalWindow;
                terminalWindow = null; 

                // --- FIX: Move the terminal's DOM back ---
                originalTerminalContainer.appendChild(term.element);
                
                // Restore container styles
                originalTerminalContainer.style.flexGrow = '4';
                originalTerminalContainer.style.height = '';
                originalTerminalContainer.style.overflow = '';
                editorContainer.style.flexGrow = '6';

                // Resize both components
                fitAddon.fit();
                editor.layout();
                term.focus();

                win.onbeforeunload = null;
                win.close();
                
                detachButton.textContent = 'Detach Terminal';
            }
            
            detachButton.addEventListener('click', () => {
                if (terminalWindow) {
                    reattachTerminal();
                } else {
                    // --- FIX: Hide the container ---
                    originalTerminalContainer.style.flexGrow = '0';
                    originalTerminalContainer.style.height = '0';
                    originalTerminalContainer.style.overflow = 'hidden';
                    editorContainer.style.flexGrow = '1';
                    
                    terminalWindow = window.open('', 'TerminalWindow', 'width=800,height=600');
                    if (!terminalWindow) {
                        alert('Popup blocked. Please allow popups for this site.');
                        reattachTerminal(); // Reset layout
                        return;
                    }
                    
                    // Setup new window
                    terminalWindow.document.head.innerHTML = `
                        <title>Terminal</title>
                        <style>
                            body, html { 
                                margin: 0; padding: 0; height: 100%; width: 100%; 
                                overflow: hidden; background-color: #1a1a1a; 
                            }
                            /* --- FIX: Make terminal fill popup --- */
                            #popup-term-container { height: 100%; width: 100%; }
                            .xterm { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
                        </style>
                    `;
                    const xtermCss = terminalWindow.document.createElement('link');
                    xtermCss.rel = 'stylesheet';
                    xtermCss.href = 'https://cdn.jsdelivr.net/npm/xterm/css/xterm.css';
                    terminalWindow.document.head.appendChild(xtermCss);
                    
                    const newTermContainer = terminalWindow.document.createElement('div');
                    newTermContainer.id = 'popup-term-container';
                    terminalWindow.document.body.appendChild(newTermContainer);

                    // --- FIX: Move the terminal's DOM to the popup ---
                    newTermContainer.appendChild(term.element);

                    // Resize editor and terminal in their new homes
                    editor.layout();
                    fitAddon.fit();
                    term.focus();
                    
                    terminalWindow.onbeforeunload = () => {
                        reattachTerminal();
                    };
                    
                    detachButton.textContent = 'Re-attach Terminal';
                }
            });
        });
    </script>
</body>
</html>