<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DinosaurEDA IDE</title>

    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; 
            background-color: #1e1e1e;
        }

        #ide-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100%;
        }

        #controls {
            padding: 8px 12px;
            background-color: #333;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
            display: flex;
            gap: 10px;
        }

        .control-button {
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
        }

        #compile-button {
            background-color: #007acc;
        }
        #compile-button:hover {
            background-color: #005a9e;
        }

        #detach-button {
            background-color: #5a5a5a;
        }
        #detach-button:hover {
            background-color: #7a7a7a;
        }
        
        #generate-ai-button {
            background-color: #0c8a4d;
        }
        #generate-ai-button:hover {
            background-color: #11b866;
        }

        /* --- This is the style for the button you were missing --- */
        #generate-diagram-button { background-color: #8a0c8a; }
        #generate-diagram-button:hover { background-color: #b811b8; }

        #editor-container {
            width: 100%;
            border-bottom: 2px solid #333;
            flex-grow: 6;
            transition: all 0.2s ease;
        }

        #terminal-container {
            width: 100%;
            background-color: #1a1a1a;
            flex-grow: 4;
            transition: all 0.2s ease;
            position: relative; 
        }

        .xterm {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* --- Modal Base Styles --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            width: 600px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            color: white;
        }
        
        .modal-content h3 {
            margin-top: 0;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        #ai-modal-buttons {
            margin-top: 15px;
            text-align: right;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #ai-modal-buttons button {
            background-color: #5a5a5a;
        }
        
        /* --- AI Modal Specifics --- */
        #ai-modal-content {
            /* This selector is for the AI modal */
        }
        #ai-prompt-textarea {
            width: 100%;
            height: 150px;
            background-color: #1e1e1e;
            border: 1px solid #555;
            color: white;
            font-size: 14px;
            box-sizing: border-box;
            padding: 10px;
            margin-top: 10px;
        }
        #ai-modal-buttons button#run-generation-button {
            background-color: #0c8a4d;
        }
        #ai-modal-buttons button:disabled {
            background-color: #333;
            cursor: not-allowed;
        }

        /* --- This is the style for the diagram modal you were missing --- */
        #diagram-modal-content { width: 80vw; max-width: 1200px; }
        #diagram-image-container { 
            width: 100%; max-height: 70vh; overflow: auto; 
            background-color: #f0f0f0; border: 1px solid #ccc; 
            border-radius: 4px; display: flex; justify-content: center; align-items: center;
        }
        #diagram-image-container img { max-width: 100%; height: auto; }
        #diagram-download-link {
            background-color: #007acc; text-decoration: none;
            display: inline-block;
        }

    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
</head>

<body>
    <div id="ide-container">
        
        <div id="controls">
            <button id="compile-button" class="control-button">â–¶ Run Synthesis</button>
            <button id="detach-button" class="control-button">Detach Terminal</button>
            <button id="generate-ai-button" class="control-button">âœ¨ Generate Verilog</button>
            <button id="generate-diagram-button" class="control-button">ðŸ“Š Generate Diagram</button>
        </div>

        <div id="editor-container"></div>
        <div id="terminal-container"></div>
    </div>
    
    <div id="ai-modal-overlay" class="modal-overlay">
        <div id="ai-modal-content" class="modal-content">
            <h3>âœ¨ Generate Verilog with AI</h3>
            <p>Describe the circuit you want to build:</p>
            <textarea id="ai-prompt-textarea" placeholder="e.g., a 4-bit counter with synchronous reset..."></textarea>
            <div id="ai-modal-buttons">
                <button id="close-modal-button" class="control-button">Cancel</button>
                <button id="run-generation-button" class="control-button">Generate</button>
            </div>
        </div>
    </div>
    
    <div id="diagram-modal-overlay" class="modal-overlay">
        <div id="diagram-modal-content" class="modal-content">
            <h3>Circuit Diagram</h3>
            <div id="diagram-image-container">
                <iframe id="diagram-svg-frame" style="width: 100%; height: 60vh; border: none; background-color: white;"></iframe>
            </div>
            <div class="modal-buttons">
                <a id="diagram-download-link" href="#" download="circuit.png" class="control-button">Download</a>
                <button id="close-diagram-modal-button" class="control-button">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let editor, term, socket, terminalWindow = null; 
            
            let originalTerminalContainer = document.getElementById('terminal-container');
            let editorContainer = document.getElementById('editor-container');
            const fitAddon = new FitAddon.FitAddon();
            
            // AI Modal Elements
            const aiModal = document.getElementById('ai-modal-overlay');
            const generateAiButton = document.getElementById('generate-ai-button');
            const closeModalButton = document.getElementById('close-modal-button');
            const runGenerationButton = document.getElementById('run-generation-button');
            const aiPromptTextarea = document.getElementById('ai-prompt-textarea');
            
            // --- These are the diagram modal elements you were missing ---
            const diagramModal = document.getElementById('diagram-modal-overlay');
            const generateDiagramButton = document.getElementById('generate-diagram-button');
            const closeDiagramModalButton = document.getElementById('close-diagram-modal-button');
            const diagramImage = document.getElementById('diagram-image');
            const diagramDownloadLink = document.getElementById('diagram-download-link');

            // --- 1. INITIALIZE MONACO EDITOR ---
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], () => {
                editor = monaco.editor.create(editorContainer, {
                    value: ['// --- Describe your circuit and click "Generate Verilog" ---'].join('\n'),
                    language: 'verilog',
                    theme: 'vs-dark'
                });
                window.addEventListener('resize', () => {
                    editor.layout();
                    fitAddon.fit();
                });
            });

            // --- 2. INITIALIZE XTERM.JS TERMINAL ---
            term = new Terminal({ cursorBlink: true, theme: { background: '#1a1a1a' } });
            term.loadAddon(fitAddon);
            term.open(originalTerminalContainer);
            fitAddon.fit(); 
            term.write('Welcome to the HDL Compiler Terminal!\r\n');
            term.write('Connecting to backend server...\r\n');

            // --- 3. INITIALIZE WEBSOCKET ---
            const WEBSOCKET_URL = `wss://${window.location.host}/compile`; 

            function connectWebSocket() {
                try {
                    socket = new WebSocket(WEBSOCKET_URL);

                    socket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (data.type === 'terminalLog') {
                                // This is a log message, print it to the terminal
                                term.write(data.message.replace(/\n/g, '\r\n'));
                                
                            } else if (data.type === 'generationResult') {
                                // This is AI-generated code, put it in the editor
                                editor.setValue(data.code);
                                aiModal.style.display = 'none'; // Hide modal
                                runGenerationButton.disabled = false;
                                runGenerationButton.textContent = 'Generate';
                                
                            // --- This is the message handler you were missing ---
                            } else if (data.type === 'diagramResult') {
                                if (data.svgDataUri) {
                                    // Set the iframe content
                                    document.getElementById('diagram-svg-frame').src = data.svgDataUri;
                                    // Set the download link
                                    diagramDownloadLink.href = data.svgDataUri;
                                    diagramDownloadLink.download = 'circuit.svg'; // Download as .svg
                                    diagramModal.style.display = 'flex';
                                } else {
                                    term.write('\r\n--- ERROR: Failed to generate diagram. ---\r\n');
                                }
                            }
                        } catch (e) {
                            console.error("Received non-JSON message:", event.data);
                        }
                    };
                    
                    socket.onopen = () => term.write('\x1b[32mSuccessfully connected to backend.\x1b[0m\r\n');
                    socket.onerror = (error) => term.write('\x1b[31mWebSocket Error.\x1b[0m\r\n');
                    socket.onclose = () => term.write('\x1b[33mConnection to backend closed.\x1b[0m\r\n');
                } catch (err) {
                    term.write('\x1b[31mFailed to create WebSocket. ' + err.message + '\x1b[0m\r\n');
                }
            }
            connectWebSocket();

            // --- 4. HOOK UP "RUN" BUTTON ---
            document.getElementById('compile-button').addEventListener('click', () => {
                if (!editor) return;
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                    return;
                }
                const code = editor.getValue();
                // Send as a JSON message
                socket.send(JSON.stringify({ type: 'compile', code: code }));
                term.write('\x1b[2J\x1b[H--- Compilation started... ---\r\n');
            });

            // --- 5. DETACH/RE-ATTACH LOGIC ---
            const detachButton = document.getElementById('detach-button');
            function reattachTerminal() {
                if (!terminalWindow) return; 
                const win = terminalWindow;
                terminalWindow = null; 
                originalTerminalContainer.appendChild(term.element);
                originalTerminalContainer.style.flexGrow = '4';
                originalTerminalContainer.style.height = '';
                originalTerminalContainer.style.overflow = '';
                editorContainer.style.flexGrow = '6';
                fitAddon.fit();
                editor.layout();
                term.focus();
                win.onbeforeunload = null;
                win.close();
                detachButton.textContent = 'Detach Terminal';
            }
            detachButton.addEventListener('click', () => {
                if (terminalWindow) {
                    reattachTerminal();
                } else {
                    originalTerminalContainer.style.flexGrow = '0';
                    originalTerminalContainer.style.height = '0';
                    originalTerminalContainer.style.overflow = 'hidden';
                    editorContainer.style.flexGrow = '1';
                    terminalWindow = window.open('', 'TerminalWindow', 'width=800,height=600');
                    if (!terminalWindow) {
                        alert('Popup blocked. Please allow popups for this site.');
                        reattachTerminal(); 
                        return;
                    }
                    terminalWindow.document.head.innerHTML = `<title>Terminal</title><style>body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #1a1a1a; } #popup-term-container { height: 100%; width: 100%; } .xterm { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }</style>`;
                    const xtermCss = terminalWindow.document.createElement('link');
                    xtermCss.rel = 'stylesheet';
                    xtermCss.href = 'https://cdn.jsdelivr.net/npm/xterm/css/xterm.css';
                    terminalWindow.document.head.appendChild(xtermCss);
                    const newTermContainer = terminalWindow.document.createElement('div');
                    newTermContainer.id = 'popup-term-container';
                    terminalWindow.document.body.appendChild(newTermContainer);
                    newTermContainer.appendChild(term.element);
                    editor.layout();
                    fitAddon.fit();
                    term.focus();
                    terminalWindow.onbeforeunload = () => {
                        reattachTerminal();
                    };
                    detachButton.textContent = 'Re-attach Terminal';
                }
            });

            // --- 6. AI MODAL LISTENERS ---
            generateAiButton.addEventListener('click', () => {
                aiModal.style.display = 'flex';
            });
            
            closeModalButton.addEventListener('click', () => {
                aiModal.style.display = 'none';
            });
            
            runGenerationButton.addEventListener('click', () => {
                const prompt = aiPromptTextarea.value;
                if (!prompt) {
                    alert('Please enter a description for your circuit.');
                    return;
                }
                
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    term.write('\x1b[31mNot connected. Reconnecting...\x1b[0m\r\n');
                    connectWebSocket();
                    return;
                }
                
                runGenerationButton.disabled = true;
                runGenerationButton.textContent = 'Generating...';
                
                socket.send(JSON.stringify({ type: 'generate', prompt: prompt }));
            });
            
            // --- 7. This is the diagram button listener you were missing ---
            generateDiagramButton.addEventListener('click', () => {
                const code = editor.getValue();
                if (!code) {
                    alert('Please enter some Verilog code first.');
                    return;
                }
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                    return;
                }
                term.write('\r\n--- ðŸ“Š Generating circuit diagram... ---\r\n');
                socket.send(JSON.stringify({ type: 'generateDiagram', code: code }));
            });
            
            closeDiagramModalButton.addEventListener('click', () => {
                diagramModal.style.display = 'none';
                document.getElementById('diagram-svg-frame').src = 'about:blank'; // Clear svg to save memory
            });

        });
    </script>
</body>
</html>